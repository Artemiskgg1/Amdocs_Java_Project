-- USERS
CREATE TABLE USERS (
  USER_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  FULL_NAME    VARCHAR2(100)   NOT NULL,
  EMAIL        VARCHAR2(120)   NOT NULL UNIQUE,
  GENDER       CHAR(1)         CHECK (GENDER IN ('M','F','O')),
  DOB          DATE,
  HEIGHT_CM    NUMBER(5,2),
  CREATED_AT   TIMESTAMP       DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT   TIMESTAMP
);

-- EXERCISE (master list)
CREATE TABLE EXERCISE (
  EXERCISE_ID  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NAME         VARCHAR2(80)  NOT NULL UNIQUE,
  CATEGORY     VARCHAR2(40)  CHECK (CATEGORY IN ('Strength','Cardio','Flexibility','Balance','Other')),
  UNIT         VARCHAR2(20)  CHECK (UNIT IN ('reps','minutes','km','kg','calories','meters','other')),
  MET_VALUE    NUMBER(4,2)   -- optional for cardio calorie est.
);

-- A workout session for a user (day/time)
CREATE TABLE WORKOUT_SESSION (
  SESSION_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID        NUMBER NOT NULL
                   REFERENCES USERS(USER_ID) ON DELETE CASCADE,
  SESSION_DATE   DATE DEFAULT TRUNC(SYSDATE) NOT NULL,
  DURATION_MIN   NUMBER(5,0),
  NOTES          VARCHAR2(4000)
);

CREATE INDEX IDX_WS_USER ON WORKOUT_SESSION(USER_ID);

-- Sets logged inside a session
CREATE TABLE WORKOUT_EXERCISE (
  SESSION_ID    NUMBER NOT NULL
                  REFERENCES WORKOUT_SESSION(SESSION_ID) ON DELETE CASCADE,
  EXERCISE_ID   NUMBER NOT NULL
                  REFERENCES EXERCISE(EXERCISE_ID),
  SET_NO        NUMBER(3) NOT NULL,
  REPS          NUMBER(5,0),
  WEIGHT_KG     NUMBER(6,2),
  DURATION_MIN  NUMBER(5,0),
  DIST_KM       NUMBER(6,2),
  CONSTRAINT PK_WE PRIMARY KEY (SESSION_ID, EXERCISE_ID, SET_NO)
);

CREATE INDEX IDX_WE_EXERCISE ON WORKOUT_EXERCISE(EXERCISE_ID);

-- Food/nutrition logs
CREATE TABLE NUTRITION_LOG (
  LOG_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID     NUMBER NOT NULL REFERENCES USERS(USER_ID) ON DELETE CASCADE,
  LOG_DATE    DATE DEFAULT TRUNC(SYSDATE) NOT NULL,
  MEAL_TYPE   VARCHAR2(20) CHECK (MEAL_TYPE IN ('Breakfast','Lunch','Dinner','Snack')),
  ITEM        VARCHAR2(100),
  CALORIES    NUMBER(6,0),
  PROTEIN_G   NUMBER(6,2),
  CARBS_G     NUMBER(6,2),
  FAT_G       NUMBER(6,2)
);

CREATE INDEX IDX_NL_USER_DATE ON NUTRITION_LOG(USER_ID, LOG_DATE);

-- Goals
CREATE TABLE GOAL (
  GOAL_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID      NUMBER NOT NULL REFERENCES USERS(USER_ID) ON DELETE CASCADE,
  GOAL_TYPE    VARCHAR2(30) CHECK (GOAL_TYPE IN ('Weight','Calories','Distance','Duration','BodyFat','Other')),
  TARGET_VALUE NUMBER(10,2) NOT NULL,
  TARGET_DATE  DATE,
  CREATED_AT   DATE DEFAULT TRUNC(SYSDATE),
  STATUS       VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE','ACHIEVED','CANCELLED'))
);

CREATE INDEX IDX_GOAL_USER ON GOAL(USER_ID);

-- Body measurements
CREATE TABLE BODY_METRICS (
  METRIC_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID       NUMBER NOT NULL REFERENCES USERS(USER_ID) ON DELETE CASCADE,
  MEASURED_ON   DATE DEFAULT TRUNC(SYSDATE) NOT NULL,
  WEIGHT_KG     NUMBER(6,2),
  BODY_FAT_PCT  NUMBER(5,2),
  CHEST_CM      NUMBER(6,2),
  WAIST_CM      NUMBER(6,2),
  HIP_CM        NUMBER(6,2),
  BMI           NUMBER(5,2)   -- auto-filled by trigger below
);

CREATE INDEX IDX_BM_USER_DATE ON BODY_METRICS(USER_ID, MEASURED_ON);

-- Sleep logs
CREATE TABLE SLEEP_LOG (
  SLEEP_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID      NUMBER NOT NULL REFERENCES USERS(USER_ID) ON DELETE CASCADE,
  SLEEP_DATE   DATE DEFAULT TRUNC(SYSDATE) NOT NULL,
  DURATION_HRS NUMBER(4,2),
  QUALITY      NUMBER(1) CHECK (QUALITY BETWEEN 1 AND 5)
);

CREATE INDEX IDX_SLEEP_USER_DATE ON SLEEP_LOG(USER_ID, SLEEP_DATE);


SELECT * FROM USERS;
SELECT * FROM EXERCISE;


SELECT * FROM BODY_METRICS;

-- ALTER TABLE EXERCISE ADD MET_VALUE NUMBER(5,2);

-- Table to store step conversion data by activity type
CREATE TABLE STEP_CONVERSION (
    CONVERSION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ACTIVITY_TYPE VARCHAR2(50) NOT NULL, -- 'WALKING', 'RUNNING', 'JOGGING'
    STEPS_PER_KM NUMBER(8,2) NOT NULL,   -- Average steps per km for this activity
    BASE_MET_VALUE NUMBER(4,2) NOT NULL  -- Base MET value for this activity
);

-- Insert some default conversion data
INSERT INTO STEP_CONVERSION (ACTIVITY_TYPE, STEPS_PER_KM, BASE_MET_VALUE) VALUES ('WALKING', 1312, 3.5);
INSERT INTO STEP_CONVERSION (ACTIVITY_TYPE, STEPS_PER_KM, BASE_MET_VALUE) VALUES ('JOGGING', 1250, 7.0);
INSERT INTO STEP_CONVERSION (ACTIVITY_TYPE, STEPS_PER_KM, BASE_MET_VALUE) VALUES ('RUNNING', 1200, 8.5);

ALTER TABLE WORKOUT_EXERCISE ADD STEPS_COUNT NUMBER(10,0);

ALTER TABLE EXERCISE DROP CONSTRAINT SYS_C008251;

ALTER TABLE EXERCISE ADD CONSTRAINT CHK_EXERCISE_UNIT 
CHECK (UNIT IN ('reps','minutes','km','kg','calories','meters','steps','other'));


SELECT * FROM BODY_METRICS;
SELECT * FROM STEP_CONVERSION;